=========================================================
-- Electronic Ordering System Database Schema
-- MySQL | 3NF | Minimum 6+ related tables
-- =========================================================

DROP DATABASE IF EXISTS electronic_ordering_system;
CREATE DATABASE electronic_ordering_system;
USE electronic_ordering_system;

-- =========================================================
-- 1. ROLES
-- =========================================================
CREATE TABLE roles (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) UNIQUE NOT NULL
);

INSERT INTO roles (name) VALUES
('admin'),
('customer');


-- =========================================================
-- 2. USERS
-- =========================================================
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    role_id INT NOT NULL DEFAULT 2,
    full_name VARCHAR(120) NOT NULL,
    email VARCHAR(150) UNIQUE NOT NULL,
    phone VARCHAR(20),
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (role_id) REFERENCES roles(id)
        ON DELETE RESTRICT ON UPDATE CASCADE
);


-- =========================================================
-- 3. CATEGORIES
-- =========================================================
CREATE TABLE categories (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


-- =========================================================
-- 4. PRODUCTS
-- =========================================================
CREATE TABLE products (
    id INT PRIMARY KEY AUTO_INCREMENT,
    category_id INT NOT NULL,
    name VARCHAR(150) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    stock INT NOT NULL DEFAULT 0,
    image VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (category_id) REFERENCES categories(id)
        ON DELETE CASCADE ON UPDATE CASCADE
);


-- =========================================================
-- 5. CARTS (one cart per user)
-- =========================================================
CREATE TABLE carts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id)
        ON DELETE CASCADE ON UPDATE CASCADE
);


-- =========================================================
-- 6. CART ITEMS
-- =========================================================
CREATE TABLE cart_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    cart_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,

    FOREIGN KEY (cart_id) REFERENCES carts(id)
        ON DELETE CASCADE ON UPDATE CASCADE,

    FOREIGN KEY (product_id) REFERENCES products(id)
        ON DELETE CASCADE ON UPDATE CASCADE,

    UNIQUE(cart_id, product_id)
);


-- =========================================================
-- 7. ORDERS
-- =========================================================
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    status ENUM('pending','paid','shipped','delivered','cancelled') DEFAULT 'pending',
    address TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id)
        ON DELETE CASCADE ON UPDATE CASCADE
);


-- =========================================================
-- 8. ORDER ITEMS
-- =========================================================
CREATE TABLE order_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    quantity INT NOT NULL,

    FOREIGN KEY (order_id) REFERENCES orders(id)
        ON DELETE CASCADE ON UPDATE CASCADE,

    FOREIGN KEY (product_id) REFERENCES products(id)
        ON DELETE CASCADE ON UPDATE CASCADE
);


-- =========================================================
-- 9. PAYMENTS (optional but professional)
-- =========================================================
CREATE TABLE payments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL,
    method VARCHAR(50),
    amount DECIMAL(10,2),
    status ENUM('pending','completed','failed') DEFAULT 'pending',
    paid_at TIMESTAMP NULL,

    FOREIGN KEY (order_id) REFERENCES orders(id)
        ON DELETE CASCADE ON UPDATE CASCADE
);


-- =========================================================
-- INDEXES (performance)
-- =========================================================
CREATE INDEX idx_products_name ON products(name);
CREATE INDEX idx_products_category ON products(category_id);
CREATE INDEX idx_orders_user ON orders(user_id);
CREATE INDEX idx_cart_items_cart ON cart_items(cart_id);


-- =========================================================
-- SAMPLE DATA (optional for testing)
-- =========================================================
INSERT INTO categories (name, description) VALUES
('Smartphones', 'Mobile phones and accessories'),
('Laptops', 'Computers and laptops'),
('Headphones', 'Audio devices');

INSERT INTO products (category_id, name, description, price, stock, image) VALUES
(1, 'Samsung Galaxy A15', 'Android smartphone', 180.00, 50, 'uploads/products/a15.jpg'),
(2, 'HP ProBook 450', 'Business laptop', 650.00, 20, 'uploads/products/hp450.jpg'),
(3, 'Wireless Headset', 'Bluetooth headphones', 35.00, 100, 'uploads/products/headset.jpg');
